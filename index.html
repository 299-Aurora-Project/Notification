<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurora Forecast Pro v t1.1.13</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b132b">
<link rel="apple-touch-icon" href="icon.png">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: system-ui, sans-serif; background:#0b132b; color:#eaeaea; padding:20px; margin:0; }
.container { max-width:600px; margin: 0 auto; }
.header-area { display: flex; flex-direction: column; margin-bottom: 10px; }
.produce-by { font-size: 0.7rem; color: #8b949e; margin-top: -5px; margin-bottom: 10px; align-self: flex-end; }
.version { font-size: 0.4em; vertical-align: middle; color: #5bc0be; margin-left: 8px; font-weight: normal; }
.title-row { display: flex; justify-content: space-between; align-items: baseline; width: 100%; }
.beta-suffix { font-size: 0.6em; color: #8b949e; font-weight: normal; margin-left: 5px; text-transform: lowercase; }
h1 { margin: 0; font-size: 1.5rem; }
.card { background:#1c2541; padding:20px; border-radius:12px; margin-bottom:20px; position: relative; border: 1px solid #30363d; }
.label-main { font-size: 1.1rem; font-weight: bold; color: #5bc0be; margin-bottom: 0px; }
.label-sub-current { font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; }
.value { font-size:1.6em; margin-top:4px; min-height: 1.2em; }
.sub-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #30363d; position: relative; }
.badge { display:inline-block; padding:10px 24px; border-radius:30px; font-weight:bold; font-size: 1.2rem; letter-spacing: 0.05em; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-top: 5px; position: relative; }
.badge-large { font-size: 1.5rem; }
.low { background:#475569; } .mid { background:#ca8a04; } .high { background:#dc2626; }
.cloud-icon { font-size: 0.8em; margin-left: 8px; vertical-align: middle; }
input, button { margin-top:6px; padding:6px 12px; border-radius: 4px; border: none; font-weight: bold; }
button { cursor: pointer; background: #3a506b; color: white; transition: 0.2s; font-size: 0.9rem; }
button:hover:not(:disabled) { background: #5bc0be; color: #0b132b; }
button:disabled { opacity: 0.3; cursor: not-allowed; }
#btn-gps { width: auto; min-width: 220px; padding: 10px 20px; margin-bottom: 15px; }
.search-container { position: relative; display: inline-block; width: 100%; margin-top: 5px; }
#cityInput { width: calc(100% - 100px); box-sizing: border-box; }
.autocomplete-items { position: absolute; border: 1px solid #3a506b; border-bottom: none; border-top: none; z-index: 100; top: 100%; left: 0; right: 100px; background-color: #1c2541; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; }
.autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #30363d; font-size: 0.85rem; }
.autocomplete-item:hover { background-color: #3a506b; color: #5bc0be; }
.refresh-btn { position: absolute; top: 15px; right: 15px; font-size: 0.8em; padding: 4px 8px; }
.sub-refresh-btn { position: absolute; top: 15px; right: 0; font-size: 0.8em; padding: 4px 8px; }
.last-updated { font-size: 0.65rem; color: #8b949e; text-align: right; margin-top: 4px; font-family: monospace; }
.refresh-btn + .last-updated { position: absolute; top: 40px; right: 15px; width: auto; }
.sub-refresh-btn + .last-updated { position: absolute; top: 40px; right: 0; width: auto; }
.error-msg { color: #ff6b6b; font-size: 0.75rem; margin-top: 5px; min-height: 1em; opacity: 0; transition: 0.3s; }
.loading-text { opacity: 0.6; font-size: 1rem; color: #8b949e; font-style: normal; }
.loading-text i { font-style: italic; }
.loading-btn { pointer-events: none; filter: grayscale(0.5); opacity: 0.7; }
#hidden-data { display: none; }
.toggle-btn { width: 100%; margin-bottom: 20px; background: #1c2541; border: 1px solid #3a506b; color: #5bc0be; }
pre { background:#0b132b; padding:12px; border-radius:8px; font-family: monospace; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid #3a506b; min-height: 50px; }
#welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 30000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
.welcome-box { background: #5bc0be; color: #0b132b; padding: 25px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; z-index: 30001; }
.arrow-container { display: flex; gap: 15px; margin-bottom: 10px; }
.thin-arrow { font-size: 2.5rem; color: #5bc0be; font-weight: 100; animation: bounceThin 1.2s infinite; }
@keyframes bounceThin { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-15px); opacity: 1; } }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; cursor: pointer; }
.modal-content { background: #1c2541; width: 90%; max-width: 450px; padding: 25px; border-radius: 12px; position: relative; border: 1px solid #5bc0be; line-height: 1.6; cursor: default; max-height: 90vh; overflow-y: auto; }
.close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #8b949e; }
.score-big { font-size: 2.5rem; text-align: center; color: #fff; margin: 10px 0; font-weight: bold; }
.detail-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
.detail-table th, .detail-table td { text-align: left; padding: 8px; border-bottom: 1px solid #30363d; }
#map-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: #000; }
#map { width: 100%; height: 100%; background: #000; }
#back-btn { position: absolute; top: 90px; left: 10px; z-index: 10000; background: #21262d; border: 1px solid #30363d; color: white; padding: 8px 16px; }

/* Notification Features Integration */
.notification-card { border: 1px dashed #5bc0be !important; margin-bottom: 20px; }
.btn-test { background: #ca8a04 !important; width: 100%; }
.switch { position: relative; display: inline-block; width: 44px; height: 22px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a506b; transition: .4s; border-radius: 22px; }
.slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #5bc0be; }
input:checked + .slider:before { transform: translateX(22px); }
.switch-label { font-size: 0.7rem; color: #5bc0be; font-weight: bold; margin-bottom: 3px; }
.search-disabled { opacity: 0.4; pointer-events: none; }
</style>
</head>
<body onkeydown="closeWelcome()" onclick="closeWelcome(); closeAllLists();">

<div id="welcome-overlay">
Â  Â  <div class="arrow-container">
Â  Â  Â  Â  <div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div>
Â  Â  </div>
Â  Â  <div class="welcome-box">Please enter a location first</div>
</div>

<div id="home-screen" class="container">
Â  Â  <div class="header-area">
Â  Â  Â  Â  <div class="title-row">
Â  Â  Â  Â  Â  Â  <h1>ğŸŒŒ Aurora Forecast Pro<span class="beta-suffix">(beta)</span> <span class="version">v t1.1.13</span></h1>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="produce-by">Produce by Shin</div>
Â  Â  </div>

Â  Â  <div class="card notification-card">
Â  Â  Â  Â  <div class="label-main" style="font-size: 0.9rem; margin-bottom: 10px;">App Settings</div>
Â  Â  Â  Â  <button id="btn-notif-test" class="btn-test" onclick="testNotification(); event.stopPropagation();">Send Test Notification (10s delay)</button>
Â  Â  </div>

Â  Â  <div class="card" id="card-loc">
Â  Â  Â  Â  <div class="label-main">Location</div>
Â  Â  Â  Â  <div id="loc" class="value">Not Set</div>
Â  Â  Â  Â  <button id="btn-gps" onclick="getLocation(); event.stopPropagation();">Get Current Location via GPS</button><br>
Â  Â  Â  Â  Search City:
Â  Â  Â  Â  <div class="search-container">
Â  Â  Â  Â  Â  Â  <input id="cityInput" placeholder="e.g. Fairbanks, AK" oninput="handleCityInput(this)" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  <button id="btn-search" onclick="searchCity(); event.stopPropagation();" disabled>Set</button>
Â  Â  Â  Â  Â  Â  <div id="autocomplete-list" class="autocomplete-items"></div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="search-error" class="error-msg">City not found. Please check your input.</div>
Â  Â  </div>

Â  Â  <div class="card" id="card-main-result">
Â  Â  Â  Â  <div style="display: flex; justify-content: space-between; align-items: flex-start;">
Â  Â  Â  Â  Â  Â  <div style="flex: 1;">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="total-label" class="label-main">Overall Probability</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="total-sub-label" class="label-sub-current">Current:</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div style="display: flex; flex-direction: column; align-items: flex-end;">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="switch-label">Notification</span>
Â  Â  Â  Â  Â  Â  Â  Â  <label class="switch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="notif-toggle" onchange="handleNotifToggle(this)">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="slider"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="result" class="badge badge-large low">--</div>
Â  Â  Â  Â  <div style="margin-top: 15px;">
Â  Â  Â  Â  Â  Â  <button onclick="openModal(); event.stopPropagation();" style="font-size: 0.85em; background: #1c2541; border: 1px solid #3a506b; padding: 8px 16px;">View Details</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <button id="btn-update-all" class="refresh-btn" onclick="updateAll(); event.stopPropagation();">Update All</button>
Â  Â  Â  Â  <div id="time-update-all" class="last-updated"></div>
Â  Â  </div>

Â  Â  <button id="toggle-data-btn" class="toggle-btn" onclick="toggleData(); event.stopPropagation();">Show All Information</button>

Â  Â  <div id="hidden-data">
Â  Â  Â  Â  <div class="card" id="card-oval">
Â  Â  Â  Â  Â  Â  <div class="label-main">Aurora Oval</div>
Â  Â  Â  Â  Â  Â  <div class="label-sub-current">Current:</div>
Â  Â  Â  Â  Â  Â  <div id="oval" class="badge low">--</div>
Â  Â  Â  Â  Â  Â  <div id="oval-prob" style="font-size: 0.9rem; color: #8b949e; margin: 10px 0;"></div>
Â  Â  Â  Â  Â  Â  <button onclick="showMapScreen(); event.stopPropagation();" style="background: #238636;">View Aurora Map</button>
Â  Â  Â  Â  Â  Â  <button id="btn-refresh-oval" class="refresh-btn" onclick="refreshItem('oval'); event.stopPropagation();">Refresh</button>
Â  Â  Â  Â  Â  Â  <div id="time-oval" class="last-updated"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" id="card-kp-group">
Â  Â  Â  Â  Â  Â  <div class="label-main">Kp Index</div>
Â  Â  Â  Â  Â  Â  <div class="label-sub-current">Current:</div>
Â  Â  Â  Â  Â  Â  <div id="kp" class="badge low">--</div>
Â  Â  Â  Â  Â  Â  <button id="btn-refresh-kp" class="refresh-btn" onclick="refreshItem('kp'); event.stopPropagation();">Refresh</button>
Â  Â  Â  Â  Â  Â  <div id="time-kp" class="last-updated"></div>
Â  Â  Â  Â  Â  Â  <div class="sub-section" id="card-kp3">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="kp-short" class="value" style="font-size: 1rem;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <pre id="kpForecast" style="margin-top:10px;">--</pre>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-refresh-kp3" class="sub-refresh-btn" onclick="refreshItem('kp3'); event.stopPropagation();">Refresh</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="time-kp3" class="last-updated"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="card" id="card-cloud-group">
Â  Â  Â  Â  Â  Â  <div class="label-main">Cloud Cover</div>
Â  Â  Â  Â  Â  Â  <div class="label-sub-current">Current:</div>
Â  Â  Â  Â  Â  Â  <div id="cloud" class="badge low">--</div>
Â  Â  Â  Â  Â  Â  <button id="btn-refresh-cloud" class="refresh-btn" onclick="refreshItem('cloud'); event.stopPropagation();">Refresh</button>
Â  Â  Â  Â  Â  Â  <div id="time-cloud" class="last-updated"></div>
Â  Â  Â  Â  Â  Â  <div class="sub-section" id="card-short">
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="forecast" class="value" style="font-size: 1rem;">--</div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="btn-refresh-short" class="sub-refresh-btn" onclick="refreshItem('short'); event.stopPropagation();">Refresh</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="time-short" class="last-updated"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="notifModal" class="modal-overlay" onclick="closeNotifModal()">
Â  Â  <div class="modal-content" onclick="event.stopPropagation()">
Â  Â  Â  Â  <span class="close-modal" onclick="closeNotifModal()">&times;</span>
Â  Â  Â  Â  <div style="color:#5bc0be; font-weight:bold; margin-bottom:15px; font-size: 1.1rem;">Notification Settings</div>
Â  Â  Â  Â  <label style="display:block; margin-bottom:12px; cursor:pointer; font-size: 0.9rem;">
Â  Â  Â  Â  Â  Â  <input type="radio" name="notif-loc-type" value="current" checked onchange="toggleNotifSearch(false)"> Current location
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <label style="display:block; margin-bottom:8px; cursor:pointer; font-size: 0.9rem;">
Â  Â  Â  Â  Â  Â  <input type="radio" name="notif-loc-type" value="another" onchange="toggleNotifSearch(true)"> Select another
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <div id="notif-search-ui" class="search-disabled" style="margin-top:10px;">
Â  Â  Â  Â  Â  Â  <div class="search-container" style="width: 100%;">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="notifCityInput" placeholder="Search City..." oninput="handleCityInput(this)" style="width: calc(100% - 90px);">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="notif-autocomplete-list" class="autocomplete-items" style="right: 90px;"></div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="margin-top:25px; text-align:right;">
Â  Â  Â  Â  Â  Â  <button id="btn-notif-done" onclick="saveNotifSettings()" style="background:#5bc0be; color:#0b132b; padding:10px 25px; border-radius: 6px;">Done</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal()">
Â  Â  <div class="modal-content" onclick="event.stopPropagation()">
Â  Â  Â  Â  <span class="close-modal" onclick="closeModal()">&times;</span>
Â  Â  Â  Â  <div class="modal-title" id="modal-label-title">Probability Details</div>
Â  Â  Â  Â  <div class="score-big"><span id="score-pct">--</span></div>
Â  Â  Â  Â  <div style="font-size: 0.85rem; margin-bottom: 15px;">
Â  Â  Â  Â  Â  Â  <div style="border: 1px solid #3a506b; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #0b132b;">
Â  Â  Â  Â  Â  Â  Â  Â  <strong style="color: #5bc0be;">Thresholds:</strong>
Â  Â  Â  Â  Â  Â  Â  Â  <ul style="margin: 5px 0; padding-left: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><span style="color: #dc2626;">High</span>: 70% or more</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><span style="color: #ca8a04;">Possible</span>: 35% to 69%</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li><span style="color: #8b949e;">Low</span>: Under 35%</li>
Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <strong>Optimized Logic (v t1.0.13+):</strong>
Â  Â  Â  Â  Â  Â  <table class="detail-table">
Â  Â  Â  Â  Â  Â  Â  Â  <tr><th>Item</th><th>Max</th><th>Details</th></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>Oval/Horizon</td><td>45</td><td>Base prob + Viewline bonus</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>Magnetic</td><td>40</td><td>Kp Index sensitivity adjusted</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  <tr><td>Sky</td><td>15</td><td>Clear sky impact</td></tr>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="map-screen">
Â  Â  <button class="btn" id="back-btn" onclick="hideMapScreen();">â† Back</button>
Â  Â  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CORS = "https://corsproxy.io/?";
const KP_URL = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
const OVAL_URL = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";
const FORECAST_URL = "https://services.swpc.noaa.gov/text/3-day-forecast.txt";

let myLat = null; let myLon = null; let lastAuroraProb = 0; let cachedAuroraData = null;
let map = null; let auroraLayer = null; let userMarker = null; let cloudDataHourly = null;
let currentTotalScore = 0; let lastScrollPos = 0; let searchTimer = null;
let isNotifSettingsSaved = false;

// --- Notification Logic ---
async function handleNotifToggle(el) {
Â  Â  if (el.checked) {
Â  Â  Â  Â  const permission = await Notification.requestPermission();
Â  Â  Â  Â  if (permission === "granted") {
Â  Â  Â  Â  Â  Â  isNotifSettingsSaved = false;
Â  Â  Â  Â  Â  Â  document.getElementById("notifModal").style.display = "flex";
Â  Â  Â  Â  Â  Â  updateDoneButtonState();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  el.checked = false;
Â  Â  Â  Â  Â  Â  alert("Please enable notifications in your browser settings.");
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  localStorage.setItem('notifEnabled', 'false');
Â  Â  }
}

function closeNotifModal() {
Â  Â  if (!isNotifSettingsSaved) {
Â  Â  Â  Â  document.getElementById("notif-toggle").checked = false;
Â  Â  Â  Â  localStorage.setItem('notifEnabled', 'false');
Â  Â  }
Â  Â  document.getElementById("notifModal").style.display = "none";
}

function saveNotifSettings() {
Â  Â  isNotifSettingsSaved = true;
Â  Â  localStorage.setItem('notifEnabled', 'true');
Â  Â  const radioAnother = document.querySelector('input[name="notif-loc-type"][value="another"]');
Â  Â  let locationName = radioAnother.checked ? document.getElementById("notifCityInput").value : (document.getElementById("loc").textContent || "Current Location");
Â  Â  alert(`Notification set for:\n${locationName}`);
Â  Â  document.getElementById("notifModal").style.display = "none";
}

function updateDoneButtonState() {
Â  Â  const radioAnother = document.querySelector('input[name="notif-loc-type"][value="another"]');
Â  Â  const doneBtn = document.getElementById("btn-notif-done");
Â  Â  const isDisabled = radioAnother.checked ? (document.getElementById("notifCityInput").value.trim() === "" || myLat === null) : (myLat === null);
Â  Â  doneBtn.disabled = isDisabled;
Â  Â  doneBtn.style.opacity = isDisabled ? "0.3" : "1";
}

function toggleNotifSearch(enabled) {
Â  Â  document.getElementById("notif-search-ui").className = enabled ? "" : "search-disabled";
Â  Â  updateDoneButtonState();
}

async function testNotification() {
Â  Â  const permission = await Notification.requestPermission();
Â  Â  if (permission === "granted") {
Â  Â  Â  Â  const btn = document.getElementById("btn-notif-test");
Â  Â  Â  Â  btn.textContent = "Wait 10s..."; btn.disabled = true;
Â  Â  Â  Â  setTimeout(async () => {
Â  Â  Â  Â  Â  Â  new Notification("ğŸŒŒ Test Alert", { body: "High priority test!", icon: "icon.png" });
Â  Â  Â  Â  Â  Â  btn.textContent = "Send Test Notification (10s delay)"; btn.disabled = false;
Â  Â  Â  Â  }, 10000);
Â  Â  }
}

// --- Base Logic ---
function formatProbability(score) {
Â  Â  const rounded = Math.round(score);
Â  Â  if (rounded <= 0) return "< 1 %";
Â  Â  if (rounded >= 100) return "> 99 %";
Â  Â  return rounded + " %";
}

setInterval(() => { if (myLat !== null) updateAll(); }, 900000);

function closeWelcome() { document.getElementById('welcome-overlay').style.display = 'none'; }
function toggleData() {
Â  Â  const hiddenSection = document.getElementById("hidden-data");
Â  Â  const btn = document.getElementById("toggle-data-btn");
Â  Â  const isHidden = hiddenSection.style.display !== "block";
Â  Â  hiddenSection.style.display = isHidden ? "block" : "none";
Â  Â  btn.textContent = isHidden ? "Show Less Information" : "Show All Information";
}

function handleCityInput(el) {
Â  Â  const isN = el.id === "notifCityInput", val = el.value.trim();
Â  Â  if (!isN) document.getElementById("btn-search").disabled = val.length === 0;
Â  Â  if (val.length < 2) { closeAllLists(); return; }
Â  Â  clearTimeout(searchTimer);
Â  Â  searchTimer = setTimeout(async () => {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=5&language=en`);
Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  showAutocomplete(data.results, isN);
Â  Â  Â  Â  } catch (e) {}
Â  Â  }, 300);
}

function showAutocomplete(results, isN) {
Â  Â  const list = document.getElementById(isN ? "notif-autocomplete-list" : "autocomplete-list");
Â  Â  list.innerHTML = ""; if (!results) return;
Â  Â  results.forEach(res => {
Â  Â  Â  Â  const item = document.createElement("div");
Â  Â  Â  Â  item.className = "autocomplete-item";
Â  Â  Â  Â  item.innerHTML = `<strong>${res.name}</strong>, ${res.country}`;
Â  Â  Â  Â  item.onclick = (e) => {
Â  Â  Â  Â  Â  Â  e.stopPropagation(); myLat = res.latitude; myLon = res.longitude;
Â  Â  Â  Â  Â  Â  const label = `${res.name}, ${res.country}`;
Â  Â  Â  Â  Â  Â  if (isN) document.getElementById("notifCityInput").value = label;
Â  Â  Â  Â  Â  Â  else document.getElementById("cityInput").value = label;
Â  Â  Â  Â  Â  Â  document.getElementById("loc").textContent = label;
Â  Â  Â  Â  Â  Â  list.innerHTML = ""; updateAll(); updateDoneButtonState();
Â  Â  Â  Â  };
Â  Â  Â  Â  list.appendChild(item);
Â  Â  });
}

function closeAllLists() { 
Â  Â  document.getElementById("autocomplete-list").innerHTML = ""; 
Â  Â  const nList = document.getElementById("notif-autocomplete-list");
Â  Â  if(nList) nList.innerHTML = "";
}

function setItemLoading(id, isLoading) {
Â  Â  const el = document.getElementById(id); if (!el) return;
Â  Â  if (isLoading) { el.dataset.oldContent = el.innerHTML; el.innerHTML = '<span class="loading-text">âŒ› <i>Loading...</i></span>'; }
}

function updateTimestamp(id) {
Â  Â  const now = new Date(); const pad = (num) => String(num).padStart(2, '0');
Â  Â  const formatted = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
Â  Â  const el = document.getElementById(id); if (el) el.textContent = `Last Update: ${formatted}`;
}

async function getLocation() {
Â  Â  setItemLoading('loc', true);
Â  Â  navigator.geolocation.getCurrentPosition(async p => {
Â  Â  Â  Â  myLat = p.coords.latitude; myLon = p.coords.longitude;
Â  Â  Â  Â  const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${myLat}&lon=${myLon}&format=json&accept-language=en`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  document.getElementById("loc").textContent = data.address.city || data.address.town || "Unknown Location";
Â  Â  Â  Â  updateAll(); updateDoneButtonState();
Â  Â  }, err => { alert("GPS Fetch Failed"); document.getElementById('loc').textContent = "Not Set"; });
}

async function searchCity() {
Â  Â  const city = document.getElementById("cityInput").value;
Â  Â  setItemLoading('loc', true);
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en`);
Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  if (data.results && data.results.length > 0) {
Â  Â  Â  Â  Â  Â  const r = data.results[0]; myLat = r.latitude; myLon = r.longitude;
Â  Â  Â  Â  Â  Â  document.getElementById("loc").textContent = `${r.name}, ${r.country}`;
Â  Â  Â  Â  Â  Â  updateAll(); updateDoneButtonState();
Â  Â  Â  Â  }
Â  Â  } catch (e) { alert("Search Error"); }
}

async function updateAll() {
Â  Â  if (myLat === null) return;
Â  Â  const btn = document.getElementById('btn-update-all'); if(btn) btn.classList.add('loading-btn');
Â  Â  setItemLoading('result', true); setItemLoading('kp', true); setItemLoading('oval', true); setItemLoading('cloud', true);
Â  Â  await Promise.all([getKp(), fetchKp3DayForecast(), checkOval(), getCloud(), shortForecast()]);
Â  Â  calculateTotal();
Â  Â  if(btn) btn.classList.remove('loading-btn');
Â  Â  updateTimestamp('time-update-all');
}

async function refreshItem(type) {
Â  Â  if (myLat === null) return alert("Please set a location first");
Â  Â  const loadMapping = { kp: 'kp', kp3: 'kp-short', oval: 'oval', cloud: 'cloud', short: 'forecast' };
Â  Â  setItemLoading(loadMapping[type], true);
Â  Â  if (type === 'kp') await getKp(); if (type === 'kp3') await fetchKp3DayForecast(); if (type === 'oval') await checkOval(); if (type === 'cloud') await getCloud(); if (type === 'short') await shortForecast();
Â  Â  calculateTotal(); updateTimestamp('time-' + type);
}

function calculateTotal() {
Â  Â  const now = new Date(); const isNight = (now.getHours() >= 21 || now.getHours() < 3);
Â  Â  document.getElementById("total-sub-label").textContent = isNight ? "Current:" : "at 21:00:";

Â  Â  let kp = parseFloat(document.getElementById("kp").dataset.value) || 0;
Â  Â  let cloud = (!isNight && cloudDataHourly) ? cloudDataHourly[21] : (parseInt(document.getElementById("cloud").dataset.value) || 0);

Â  Â  let score = (Math.min(45, lastAuroraProb * 1.2 + 10)) + (kp * 12) + 15;
Â  Â  if (cloud > 85) score *= 0.1; else if (cloud > 70) score *= 0.4;
Â  Â  currentTotalScore = Math.min(100, score);

Â  Â  const resEl = document.getElementById("result");
Â  Â  if (currentTotalScore >= 70) { resEl.innerHTML = "High"; resEl.className = "badge badge-large high"; }
Â  Â  else if (currentTotalScore >= 35) { resEl.innerHTML = "Possible"; resEl.className = "badge badge-large mid"; }
Â  Â  else { resEl.innerHTML = (score > 35 && cloud > 70 ? 'Low<span class="cloud-icon">â˜ï¸</span>' : "Low"); resEl.className = "badge badge-large low"; }

Â  Â  // Notification trigger check
Â  Â  if (localStorage.getItem('notifEnabled') === 'true' && currentTotalScore >= 35) {
Â  Â  Â  Â  new Notification("Aurora Alert!", { body: `Probability is ${Math.round(currentTotalScore)}%. Check the sky!` });
Â  Â  }
}

async function getKp() { 
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(CORS + encodeURIComponent(KP_URL)); const data = await res.json();
Â  Â  Â  Â  const val = parseFloat(data[data.length - 1][1]);
Â  Â  Â  Â  const el = document.getElementById("kp"); el.textContent = val.toFixed(1); el.dataset.value = val;
Â  Â  Â  Â  el.className = "badge " + (val >= 5 ? "high" : (val >= 3 ? "mid" : "low"));
Â  Â  Â  Â  updateTimestamp('time-kp'); return val;
Â  Â  } catch(e) { return 0; }
}

async function fetchKp3DayForecast() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(CORS + encodeURIComponent(FORECAST_URL));
Â  Â  Â  Â  const text = await res.text();
Â  Â  Â  Â  document.getElementById("kpForecast").innerText = text.match(/NOAA Kp index breakdown[\s\S]*?(?=\n[A-Z]|$)/i)[0].trim();
Â  Â  Â  Â  document.getElementById("kp-short").innerHTML = `Ref 3-day forecast (NOAA)`;
Â  Â  } catch(e) {}
}

async function checkOval() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(CORS + encodeURIComponent(OVAL_URL)); const data = await res.json(); cachedAuroraData = data;
Â  Â  Â  Â  let best = 0;
Â  Â  Â  Â  data.coordinates.forEach(p => {
Â  Â  Â  Â  Â  Â  let d = Math.abs(myLat - p[1]) + Math.abs(myLon - (p[0] > 180 ? p[0] - 360 : p[0]));
Â  Â  Â  Â  Â  Â  if (d < 2.5) best = Math.max(best, p[2]);
Â  Â  Â  Â  });
Â  Â  Â  Â  lastAuroraProb = best; document.getElementById("oval-prob").textContent = `Local Prob: ${best}%`;
Â  Â  Â  Â  const el = document.getElementById("oval"); el.textContent = best >= 10 ? "Near Oval" : "Outside Oval";
Â  Â  Â  Â  el.className = "badge " + (best >= 10 ? "high" : "low");
Â  Â  } catch(e) {}
}

async function getCloud() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&current=cloudcover`);
Â  Â  Â  Â  const data = await res.json(); const val = data.current.cloudcover;
Â  Â  Â  Â  const el = document.getElementById("cloud"); el.textContent = val + "%"; el.dataset.value = val;
Â  Â  Â  Â  el.className = "badge " + (val <= 20 ? "high" : (val <= 60 ? "mid" : "low"));
Â  Â  Â  Â  return val;
Â  Â  } catch(e) { return 100; }
}

async function shortForecast() {
Â  Â  try {
Â  Â  Â  Â  const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&hourly=cloudcover`);
Â  Â  Â  Â  const data = await res.json(); cloudDataHourly = data.hourly.cloudcover;
Â  Â  Â  Â  const hr = new Date().getHours();
Â  Â  Â  Â  document.getElementById("forecast").innerHTML = (hr >= 21 || hr < 3) ? `In 3h: Clouds ${cloudDataHourly[3]}%` : `Tonight(21:00): Clouds ${cloudDataHourly[21]}%`;
Â  Â  } catch(e) {}
}

function openModal() { if(myLat) { document.getElementById("score-pct").textContent = Math.round(currentTotalScore) + "%"; document.getElementById("detailModal").style.display = "flex"; } }
function closeModal() { document.getElementById("detailModal").style.display = "none"; }
function showMapScreen() { 
Â  Â  lastScrollPos = window.pageYOffset;
Â  Â  document.getElementById('home-screen').style.display = 'none'; document.getElementById('map-screen').style.display = 'block'; 
Â  Â  if(!map) { map = L.map('map').setView([myLat||70, myLon||0], 3); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map); }
}
function hideMapScreen() { document.getElementById('map-screen').style.display = 'none'; document.getElementById('home-screen').style.display = 'block'; window.scrollTo(0, lastScrollPos); }
</script>
</body>
</html>
