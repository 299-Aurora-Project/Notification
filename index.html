<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurora Forecast Pro v. t1.3.0</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b132b">
<link rel="apple-touch-icon" href="icon.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: system-ui, sans-serif; background:#0b132b; color:#eaeaea; padding:20px; margin:0; }
.container { max-width:600px; margin: 0 auto; }
.header-area { display: flex; flex-direction: column; margin-bottom: 10px; }
.produce-by { font-size: 0.7rem; color: #8b949e; margin-top: -5px; margin-bottom: 10px; align-self: flex-end; }
.version { font-size: 0.4em; vertical-align: middle; color: #5bc0be; margin-left: 8px; font-weight: normal; }
.title-row { display: flex; justify-content: space-between; align-items: baseline; width: 100%; }
.beta-suffix { font-size: 0.6em; color: #8b949e; font-weight: normal; margin-left: 5px; text-transform: lowercase; }
h1 { margin: 0; font-size: 1.5rem; }
.card { background:#1c2541; padding:20px; border-radius:12px; margin-bottom:20px; position: relative; border: 1px solid #30363d; }
.label-main { font-size: 1.1rem; font-weight: bold; color: #5bc0be; margin-bottom: 0px; }
.label-sub-current { font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; }
.value { font-size:1.6em; margin-top:4px; min-height: 1.2em; }
.sub-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #30363d; position: relative; }

.badge {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
    position: relative;
    /* --- ËøΩÂä†„Éª‰øÆÊ≠£ --- */
    border: none;       /* „Éú„Çø„É≥„ÅÆÊû†Á∑ö„ÇíÊ∂à„Åô */
    cursor: pointer;    /* „Éû„Ç¶„Çπ„Çí‰πó„Åõ„ÅüÊôÇ„Å´Êåá„Éû„Éº„ÇØ„Å´„Åô„Çã */
    color: white;       /* ÊñáÂ≠óËâ≤„ÇíÁôΩ„Å´Âõ∫ÂÆö */
    transition: transform 0.1s, filter 0.2s; /* Êäº„ÅóÂøÉÂú∞„ÅÆ„Åü„ÇÅ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
}

/* „Éú„Çø„É≥„ÇíÊäº„Åó„ÅüÁû¨Èñì„ÅÆ„É™„Ç¢„ÇØ„Ç∑„Éß„É≥ */
.badge:active {
    transform: scale(0.95); /* Â∞ë„ÅóÂáπ„ÇÄÊºîÂá∫ */
    filter: brightness(0.9); /* Â∞ë„ÅóÊöó„Åè„Åô„ÇãÊºîÂá∫ */
}

.badge-large { font-size: 1.5rem; }
.low { background:#475569; } .mid { background:#ca8a04; } .high { background:#dc2626; }
.cloud-icon { font-size: 0.8em; margin-left: 8px; vertical-align: middle; }
input, button { margin-top:6px; padding:6px 12px; border-radius: 4px; border: none; font-weight: bold; }
button { cursor: pointer; background: #3a506b; color: white; transition: 0.2s; font-size: 0.9rem; }
button:hover:not(:disabled) { background: #5bc0be; color: #0b132b; }
button:disabled { opacity: 0.3; cursor: not-allowed; }
#btn-gps { width: auto; min-width: 220px; padding: 10px 20px; margin-bottom: 15px; }
.search-container { position: relative; display: inline-block; width: 100%; margin-top: 5px; }
#cityInput { width: calc(100% - 100px); box-sizing: border-box; }
.autocomplete-items { position: absolute; border: 1px solid #3a506b; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 100px; background-color: #1c2541; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; }
.autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #30363d; font-size: 0.85rem; }
.autocomplete-item:hover { background-color: #3a506b; color: #5bc0be; }
.refresh-btn { position: absolute; top: 15px; right: 15px; font-size: 0.8em; padding: 4px 8px; }
.sub-refresh-btn { position: absolute; top: 15px; right: 0; font-size: 0.8em; padding: 4px 8px; }
.last-updated { font-size: 0.65rem; color: #8b949e; text-align: right; margin-top: 4px; font-family: monospace; min-height: 1em; }
.error-msg { color: #ff6b6b; font-size: 0.75rem; margin-top: 5px; min-height: 1em; opacity: 0; transition: 0.3s; }
.loading-text { opacity: 0.6; font-size: 1rem; color: #8b949e; font-style: normal; }
.loading-text i { font-style: italic; }
.loading-btn { pointer-events: none; filter: grayscale(0.5); opacity: 0.7; }
#hidden-data { display: none; }
.toggle-btn { width: 100%; margin-bottom: 20px; background: #1c2541; border: 1px solid #3a506b; color: #5bc0be; }
pre { background:#0b132b; padding:12px; border-radius:8px; font-family: monospace; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid #3a506b; min-height: 50px; }
#welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 30000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
.welcome-box { background: #5bc0be; color: #0b132b; padding: 25px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; z-index: 30001; }
.arrow-container { display: flex; gap: 15px; margin-bottom: 10px; }
.thin-arrow { font-size: 2.5rem; color: #5bc0be; font-weight: 100; animation: bounceThin 1.2s infinite; }
@keyframes bounceThin { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-15px); opacity: 1; } }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; cursor: pointer; }
.modal-content { background: #1c2541; width: 90%; max-width: 450px; padding: 25px; border-radius: 12px; position: relative; border: 1px solid #5bc0be; line-height: 1.6; cursor: default; max-height: 90vh; overflow-y: auto; }
.close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #8b949e; }
.score-big { font-size: 2.5rem; text-align: center; color: #fff; margin: 10px 0; font-weight: bold; }
.detail-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
.detail-table th, .detail-table td { text-align: left; padding: 8px; border-bottom: 1px solid #30363d; }
#map-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: #000; }
#map { width: 100%; height: 100%; background: #000; }
#back-btn { position: absolute; top: 90px; left: 10px; z-index: 10000; background: #21262d; border: 1px solid #30363d; color: white; padding: 8px 16px; }
.notification-card { border: 1px dashed #5bc0be !important; margin-top: 10px; }
.btn-test { background: #ca8a04 !important; }
.switch-container { display: flex; align-items: center; justify-content: flex-end; margin-top: 12px; gap: 10px; }
.switch-label { font-size: 0.75rem; color: #8b949e; }
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a506b; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #5bc0be; }
input:checked + .slider:before { transform: translateX(20px); }
</style>
</head>
<body onkeydown="closeWelcome()" onclick="closeWelcome(); closeAllLists();">

<div id="welcome-overlay">
    <div class="arrow-container">
        <div class="thin-arrow">‚Üë</div><div class="thin-arrow">‚Üë</div><div class="thin-arrow">‚Üë</div>
    </div>
    <div class="welcome-box">Please enter a location first</div>
</div>

<div id="home-screen" class="container">
    <div class="header-area">
        <div class="title-row">
            <h1>üåå Aurora Forecast Pro<span class="beta-suffix">(beta)</span> <span class="version">v. t1.3.0</span></h1>
        </div>
        <div class="produce-by">Produce by Shin</div>
    </div>

    <div class="card notification-card">
        <div class="label-main" style="font-size: 0.9rem;">App Settings</div>
        <button id="btn-notif-test" class="btn-test" onclick="testNotification(); event.stopPropagation();">Send Test Notification</button>
        <div id="notif-status" style="font-size: 0.7rem; color: #8b949e; margin-top: 5px;">Push notifications: Triggered on "Possible" or "High"</div>
    </div>

    <div class="card" id="card-loc">
        <div class="label-main">Location</div>
        <div id="loc" class="value">Not Set</div>
        <button id="btn-gps" onclick="getLocation(); event.stopPropagation();">Get Current Location via GPS</button><br>
        Search City:
        <div class="search-container">
            <input id="cityInput" placeholder="e.g. Yellowknife, Canada" 
       oninput="handleCityInput(this)" 
       onclick="event.stopPropagation()">
            <button id="btn-search" onclick="searchCity(); event.stopPropagation();" disabled>Set</button>
            <div id="autocomplete-list" class="autocomplete-items"></div>
        </div>
        <div id="search-error" class="error-msg">City not found. Please check your input.</div>
    </div>

    <div class="card" id="card-main-result">
    <div id="total-label" class="label-main">Overall Probability</div>
    <div id="total-sub-label" class="label-sub-current">Status:</div>
    <button id="result" class="badge badge-large low" onclick="openModal(); event.stopPropagation();" style="border: none; width: auto; display: inline-block;">--</button>
    
    <div class="switch-container" style="position: absolute; top: 15px; right: 22px; margin-top: 0; display: flex; flex-direction: column; align-items: flex-end;">
    	<div style="display: flex; align-items: center; gap: 10px;">
        	<span class="switch-label">Notification</span>
        	<label class="switch">
            	<input type="checkbox" id="notif-toggle" onchange="handleNotifToggle(this); event.stopPropagation();">
            	<span class="slider"></span>
        	</label>
    	</div>
    	<div id="target-area-display" style="font-size: 0.65rem; color: #5bc0be; margin-top: 5px; text-align: right; line-height: 1.2; display: none;">
        	Target area:<br>
        	<span id="target-area-name" style="color: #eaeaea;"></span>
    	</div>
	</div>

    <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
    	<button id="btn-update-all" 
            	style="width: auto; min-width: 100px; white-space: nowrap; font-size: 0.85em; background: #3a506b; padding: 8px 12px;" 
            	onclick="updateAll(); event.stopPropagation();">
        	Update Data
    	</button>
	</div>
    
    <div id="time-update-all" class="last-updated" style="margin-top: 10px;"></div>
</div>

    <button id="toggle-data-btn" class="toggle-btn" onclick="toggleData(); event.stopPropagation();">Show All Information</button>

    <div id="hidden-data">
        <div class="card" id="card-oval">
            <div class="label-main">Aurora Oval</div>
            <div class="label-sub-current">Current:</div>
            <div id="oval" class="badge low">--</div>
            <div id="oval-prob" style="font-size: 0.9rem; color: #8b949e; margin: 10px 0;"></div>
            <button onclick="showMapScreen(); event.stopPropagation();" style="background: #238636;">View Aurora Map</button>
        </div>

        <div class="card" id="card-kp-group">
            <div class="label-main">Kp Index</div>
            <div class="label-sub-current">Current:</div>
            <div id="kp" class="badge low">--</div>
            <div class="sub-section" id="card-kp3">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="kp-short" class="value" style="font-size: 0.85rem; color: #5bc0be;">Ref 3-day forecast (NOAA)</div>
                <pre id="kpForecast" style="margin-top:10px;">--</pre>
            </div>
        </div>

        <div class="card" id="card-cloud-group">
            <div class="label-main">Cloud Cover</div>
            <div class="label-sub-current">Current:</div>
            <div id="cloud" class="badge low">--</div>
            <div class="sub-section" id="card-short">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="forecast" class="value" style="font-size: 1rem;">--</div>
            </div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <div class="modal-title">Probability Details</div>
        <div class="score-big"><span id="score-pct">--</span></div>
        <div style="font-size: 0.85rem; margin-bottom: 15px;">
            <div style="border: 1px solid #3a506b; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #0b132b;">
                <strong style="color: #5bc0be;">Thresholds:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><span style="color: #dc2626;">High</span>: 70% or more</li>
                    <li><span style="color: #ca8a04;">Possible</span>: 35% to 69%</li>
                    <li><span style="color: #8b949e;">Low</span>: Under 35%</li>
                </ul>
            </div>
            <strong>Optimized Logic (v t1.0.13+):</strong>
            <table class="detail-table">
                <tr><th>Item</th><th>Max</th><th>Details</th></tr>
                <tr><td>Oval/Horizon</td><td>45</td><td>Base prob + Viewline bonus</td></tr>
                <tr><td>Magnetic</td><td>40</td><td>Kp Index sensitivity adjusted</td></tr>
                <tr><td>Sky</td><td>15</td><td>Clear sky impact</td></tr>
            </table>
            <p style="margin-top:10px; color: #ffab70; font-size: 0.8rem;">
                * <strong>Cloud Impact:</strong> If cloud cover exceeds 70%, the score is significantly reduced. If it exceeds 85%, the result is forced to "Low".<br><br>
                * <strong>Cloud Icon (‚òÅÔ∏è):</strong> This icon appears <strong>only when</strong> the aurora potential is "Possible" or "High" but the view is currently blocked by heavy cloud cover.
            </p>
        </div>
    </div>
</div>

<div id="map-screen">
    <button class="btn" id="back-btn" onclick="hideMapScreen();">‚Üê Back</button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CORS = "https://corsproxy.io/?";
const KP_URL = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
const OVAL_URL = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";
const FORECAST_URL = "https://services.swpc.noaa.gov/text/3-day-forecast.txt";

let myLat = null; let myLon = null; 
let notifLat = null; let notifLon = null;
let lastAuroraProb = 0; let cachedAuroraData = null;
let map = null; let auroraLayer = null; let userMarker = null; let cloudDataHourly = null;
let currentTotalScore = 0;
let lastScrollPos = 0;
let searchTimer = null;

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
}

/* --- „Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÉªÈÄöÁü•Èñ¢ÈÄ£ --- */
function updateTimestamp(id) {
    const now = new Date();
    const pad = (num) => String(num).padStart(2, '0');
    const formatted = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Last Update: ${formatted}`;
    }
}

function updateAllTimestamps() {
    ['time-update-all', 'time-kp', 'time-kp3', 'time-oval', 'time-cloud', 'time-short'].forEach(id => {
        updateTimestamp(id);
    });
}

async function testNotification() {
    const registration = await navigator.serviceWorker.ready;
    let permission = Notification.permission;
    if (permission === "default") permission = await Notification.requestPermission();
    if (permission === "granted") {
        registration.showNotification("Aurora Forecast Pro", { body: "Mobile notification is working!", icon: "icon.png" });
    }
}

/* --- „Éá„Éº„ÇøÊõ¥Êñ∞„É°„Ç§„É≥„É≠„Ç∏„ÉÉ„ÇØ --- */
async function updateAll() {
    // ‰øÆÊ≠£Ôºö„É≠„Ç±„Éº„Ç∑„Éß„É≥Êú™Ë®≠ÂÆöÊôÇ„ÅÆÂá¶ÁêÜ„ÇíËøΩÂä†
    if (myLat === null) {
        // „Ç¶„Çß„É´„Ç´„É†„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíÂÜçË°®Á§∫„Åó„Å¶„É¶„Éº„Ç∂„Éº„Å´ÈÄöÁü•„Åô„Çã
        document.getElementById('welcome-overlay').style.display = 'flex';
        // „ÅÇ„Çã„ÅÑ„ÅØ„Ç∑„É≥„Éó„É´„Å´„Ç¢„É©„Éº„Éà„ÇíÂá∫„ÅôÂ†¥Âêà: alert("Please set a location first");
        return;
    }
    
    const btn = document.getElementById('btn-update-all'); 
    if(btn) btn.classList.add('loading-btn');

    // „Éê„ÉÉ„Ç∏ÈÉ®ÂàÜ„ÅÆ„Åø„ÇíLoadingË°®Á§∫„Å´„Åô„Çã
    ['result','kp','oval','cloud'].forEach(id => setItemLoading(id, true));

    try {
        await Promise.all([
            getKp(), 
            fetchKp3DayForecast(), 
            checkOval(), 
            getCloud(), 
            shortForecast()
        ]);

        calculateTotal();
        runNotificationChecks();
        
        // ÊúÄÂæå„Å´„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÇíÊõ∏„ÅçÊèõ„Åà„Çã
        updateAllTimestamps();
        
    } catch (e) {
        console.error("Update Data failed:", e);
    } finally {
        if(btn) btn.classList.remove('loading-btn');
    }
}

function calculateTotal() {
    const now = new Date();
    const hr = now.getHours();
    
    const subLabel = document.getElementById("total-sub-label");
    const isNight = (hr >= 21 || hr < 3);
    if (subLabel) {
        subLabel.textContent = isNight ? "Current Situation:" : "Tonight's Forecast (21:00):";
    }

    let evalKp = parseFloat(document.getElementById("kp").dataset.value) || 0;
    let evalCloud = (!isNight && cloudDataHourly) ? cloudDataHourly[21] : (parseInt(document.getElementById("cloud").dataset.value) || 0);

    let ovalScore = Math.min(45, (lastAuroraProb * 1.2) + (lastAuroraProb === 0 ? 5 : 10));
    let kpScore = Math.min(40, evalKp * 12 + (evalKp >= 3 ? 5 : 0));
    let potentialScore = (ovalScore + kpScore + 15) * (lastAuroraProb > 0 ? 1.0 : (evalKp >= 4 ? 0.3 : 0));

    if (evalCloud > 85) currentTotalScore = potentialScore * 0.1;
    else if (evalCloud > 70) currentTotalScore = potentialScore * 0.4;
    else currentTotalScore = potentialScore;

    const resultEl = document.getElementById("result");
    
    // Ë°®Á§∫„Å®Âà§ÂÆö„Çí‰∏ÄËá¥„Åï„Åõ„Çã„Åü„ÇÅ„Å´ÂõõÊç®‰∫îÂÖ•
    const displayScore = Math.round(currentTotalScore);

    if (displayScore >= 70) {
        resultEl.textContent = "High";
        resultEl.className = "badge badge-large high";
    } else if (displayScore >= 35) {
        resultEl.textContent = "Possible";
        resultEl.className = "badge badge-large mid";
    } else {
        resultEl.innerHTML = `Low${(potentialScore >= 35 && evalCloud > 70 ? '<span class="cloud-icon">‚òÅÔ∏è</span>' : '')}`;
        resultEl.className = "badge badge-large low";
    }
}

/* --- Âú∞Âõ≥„Éª‰ΩçÁΩÆÊÉÖÂ†±„Éª„Åù„ÅÆ‰ªñ (‰ª•‰∏ã„ÅØÂ§âÊõ¥„Å™„Åó) --- */
async function getLocation() { setItemLoading('loc', true); navigator.geolocation.getCurrentPosition(async p => { myLat = p.coords.latitude; myLon = p.coords.longitude; await reverseGeocode(myLat, myLon); updateAll(); }, err => { alert("GPS Fetch Failed"); document.getElementById('loc').textContent = "Not Set"; }); }
function initMap() { const southLimit = -70, northLimit = 90; map = L.map('map', { minZoom: 2, maxZoom: 10, worldCopyJump: true, maxBounds: [[southLimit, -540], [northLimit, 540]], maxBoundsViscosity: 1.0 }); const startLat = myLat !== null ? myLat : 70, startLon = myLon !== null ? myLon : 0; map.setView([startLat, startLon], 3); L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: false }).addTo(map); auroraLayer = L.layerGroup().addTo(map); if (cachedAuroraData) drawAurora(cachedAuroraData); updateMapMarker(); }
function drawAurora(data) { auroraLayer.clearLayers(); data.coordinates.forEach(p => { if (p[2] > 10) { let baseLon = p[0] > 180 ? p[0] - 360 : p[0]; let color = p[2] > 50 ? '#ff4500' : (p[2] > 25 ? '#ffff00' : '#00ff00'); [-360, 0, 360].forEach(offset => { L.rectangle([[p[1], baseLon + offset], [p[1] + 2, baseLon + 2 + offset]], { color: color, weight: 0, fillOpacity: p[2] / 100, interactive: false }).addTo(auroraLayer); }); } }); }
function showMapScreen() { lastScrollPos = window.pageYOffset; document.getElementById('home-screen').style.display = 'none'; document.getElementById('map-screen').style.display = 'block'; if (!map) initMap(); else { if (myLat !== null) map.setView([myLat, myLon], map.getZoom()); updateMapMarker(); setTimeout(() => { map.invalidateSize(); }, 50); } }
function hideMapScreen() { document.getElementById('map-screen').style.display = 'none'; document.getElementById('home-screen').style.display = 'block'; window.scrollTo(0, lastScrollPos); }
function updateMapMarker() { if (!map || myLat === null) return; if (userMarker) userMarker.setLatLng([myLat, myLon]); else userMarker = L.circleMarker([myLat, myLon], { color: '#5bc0be', radius: 7, weight: 3, fillOpacity: 1.0 }).addTo(map); }
async function getKp() { try { const res = await fetch(CORS + encodeURIComponent(KP_URL)); const data = await res.json(); const val = parseFloat(data[data.length - 1][1]); const el = document.getElementById("kp"); el.textContent = val.toFixed(1); el.dataset.value = val; el.className = "badge " + (val >= 5 ? "high" : (val >= 3 ? "mid" : "low")); return val; } catch(e) { return 0; } }
async function fetchKp3DayForecast() { try { const res = await fetch(CORS + encodeURIComponent(FORECAST_URL)); const text = await res.text(); const match = text.match(/NOAA Kp index breakdown[\s\S]*?(?=\n[A-Z]|$)/i); document.getElementById("kpForecast").innerText = match ? match[0].trim() : "Updating..."; } catch(e) { } }
async function checkOval() { try { const res = await fetch(CORS + encodeURIComponent(OVAL_URL)); const data = await res.json(); cachedAuroraData = data; if (map) drawAurora(data); let bestProb = 0, minDiff = 999; data.coordinates.forEach(p => { let diff = Math.abs(myLat - p[1]) + Math.abs(myLon - (p[0] > 180 ? p[0] - 360 : p[0])); if (diff < minDiff) { minDiff = diff; bestProb = p[2]; } }); lastAuroraProb = bestProb; document.getElementById("oval-prob").textContent = `Probability at location: ${bestProb}%`; document.getElementById("oval").className = "badge " + (bestProb >= 10 ? "high" : "low"); document.getElementById("oval").textContent = (bestProb >= 10 ? "Near Oval" : "Outside Oval"); } catch(e) { } }
async function getCloud() { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&current=cloudcover`); const data = await res.json(); const val = data.current.cloudcover; const el = document.getElementById("cloud"); el.textContent = formatProbability(val); el.dataset.value = val; el.className = "badge " + (val <= 20 ? "high" : (val <= 60 ? "mid" : "low")); return val; } catch(e) { return 100; } }
async function shortForecast() { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&hourly=cloudcover`); const data = await res.json(); cloudDataHourly = data.hourly.cloudcover; const hr = new Date().getHours(); let html = (hr >= 21 || hr < 3) ? `<div>üïí In 3h: Clouds ${formatProbability(cloudDataHourly[3])}</div>` : `<div>üåô Tonight(21:00): Clouds ${formatProbability(cloudDataHourly[21])}</div>`; html += `<div>üìÖ Tomorrow(21:00): Clouds ${formatProbability(cloudDataHourly[45])}</div>`; document.getElementById("forecast").innerHTML = html; } catch(e) { } }
function setItemLoading(id, isLoading) { const el = document.getElementById(id); if (el && isLoading) el.innerHTML = '<span class="loading-text">‚åõ <i>Loading...</i></span>'; }
function formatProbability(s) { const r = Math.round(s); return (r <= 0 ? "< 1" : (r >= 100 ? "> 99" : r)) + " %"; }


async function searchCity() {
    const cityInput = document.getElementById("cityInput");
    const city = cityInput.value.trim();
    if (!city) return;

    // 1. Âãï„ÅÑ„Å¶„ÅÑ„ÇãÊ§úÁ¥¢„Çø„Ç§„Éû„Éº„ÇíÂç≥Â∫ß„Å´Ê≠¢„ÇÅ„Çã
    clearTimeout(searchTimer);

    try {
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en`);
        const data = await res.json();
        if (data.results?.length > 0) {
            const r = data.results[0];
            myLat = r.latitude;
            myLon = r.longitude;
            document.getElementById("loc").textContent = `${r.name}, ${r.country}`;
            
            // 2. ÂÖ•ÂäõÊ¨Ñ„Çí„ÇØ„É™„Ç¢
            cityInput.value = "";
            document.getElementById("btn-search").disabled = true;
            
            // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂ§ñ„Åó„Å¶„Ç≠„Éº„Éú„Éº„Éâ„ÇíÈñâ„Åò„Çã
            cityInput.blur();
            // ÁîªÈù¢„ÅÆ„Ç∫„Éº„É†/‰ΩçÁΩÆ„Çí„É™„Çª„ÉÉ„Éà
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Èù¢ÊúÄ‰∏äÈÉ®„Å∏„Çπ„É†„Éº„Ç∫„Å´Êàª„Çã

            // 3. „É™„Çπ„Éà„ÇíÁâ©ÁêÜÁöÑ„Å´Á†¥Â£ä„Åó„Å¶Á¢∫ÂÆü„Å´Ê∂à„Åô
            const list = document.getElementById("autocomplete-list");
            if (list) list.innerHTML = ""; 
            
            updateAll();
        } else {
            const err = document.getElementById("search-error");
            err.style.opacity = 1;
            setTimeout(() => { err.style.opacity = 0; }, 3000);
        }
    } catch (e) {
        console.error("Search Error");
    }
}


function handleCityInput(el) {
    const val = el.value.trim();
    const btn = document.getElementById("btn-search");
    
    // ÊñáÂ≠ó„Åå„ÅÇ„Çå„Å∞Set„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
    btn.disabled = val.length === 0;

    clearTimeout(searchTimer);
    if (val.length < 2) {
        closeAllLists();
        return;
    }

    searchTimer = setTimeout(async () => {
        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=5&language=en`);
            const data = await res.json();
            // ÂÄôË£ú„ÇíË°®Á§∫
            showAutocomplete(data.results);
        } catch(e){
            console.error("Autocomplete fetch error", e);
        }
    }, 300);
}


function showAutocomplete(results) {
    const list = document.getElementById("autocomplete-list");
    list.innerHTML = ""; // ‰∏ÄÊó¶‰∏≠Ë∫´„ÇíÁ©∫„Å´„Åô„Çã
    
    if (!results || results.length === 0) return;

    results.forEach(res => {
        const item = document.createElement("div");
        item.className = "autocomplete-item";
        item.innerHTML = `<strong>${res.name}</strong>, ${res.country}`;
        
        // click„Åß„ÅØ„Å™„Åèmousedown„Çí‰Ωø„ÅÜ„ÅÆ„Åå„Ç≥„ÉÑ„Åß„Åô
        item.onmousedown = (e) => {
            e.preventDefault(); 
            
            // 1. ‰ΩçÁΩÆÊÉÖÂ†±„ÇíÁ¢∫ÂÆö
            myLat = res.latitude;
            myLon = res.longitude;
            document.getElementById("loc").textContent = `${res.name}, ${res.country}`;
            
            // 2. Ê§úÁ¥¢Á™ì„Çí„ÇØ„É™„Ç¢
            const inputField = document.getElementById("cityInput");
            inputField.value = "";
            document.getElementById("btn-search").disabled = true;
            
            // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂ§ñ„Åó„Å¶„Ç≠„Éº„Éú„Éº„Éâ„ÇíÈñâ„Åò„Çã
            inputField.blur();
            // ÁîªÈù¢ÊúÄ‰∏äÈÉ®„Å∏„Çπ„É†„Éº„Ç∫„Å´Êàª„Çã
            window.scrollTo({ top: 0, behavior: 'smooth' }); 

            // 3. „É™„Çπ„Éà„ÇíÈñâ„Åò„Å¶Êõ¥Êñ∞
            closeAllLists();
            updateAll();
        };
        list.appendChild(item);
    });
}

function closeAllLists() {
    clearTimeout(searchTimer); // „Åì„Åì„Åß„ÇÇ„Çø„Ç§„Éû„Éº„ÇíÊ≠¢„ÇÅ„Çã
    const list = document.getElementById("autocomplete-list");
    if (list) {
        list.innerHTML = "";
    }
}


function closeWelcome() { document.getElementById('welcome-overlay').style.display = 'none'; }
function toggleData() { const h = document.getElementById("hidden-data"), b = document.getElementById("toggle-data-btn"); const isH = h.style.display !== "block"; h.style.display = isH ? "block" : "none"; b.textContent = isH ? "Show Less Information" : "Show All Information"; }

/* View Details„Éú„Çø„É≥ */
function openModal() {
    // ‰øÆÊ≠£Ôºöalert„Åß„ÅØ„Å™„Åè„Ç™„Éº„Éê„Éº„É¨„Ç§„ÇíË°®Á§∫„Åô„ÇãÊåôÂãï„Å´Áµ±‰∏Ä
    if (myLat === null) {
        document.getElementById('welcome-overlay').style.display = 'flex';
        return;
    }
    
    document.getElementById("score-pct").textContent = formatProbability(currentTotalScore);
    document.getElementById("detailModal").style.display = "flex";
}




function closeModal() { document.getElementById("detailModal").style.display = "none"; }
async function reverseGeocode(lat, lon) { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`); const data = await res.json(); document.getElementById("loc").textContent = (data.address.city || data.address.town || "Unknown") + ", " + data.address.country; } catch (e) { document.getElementById("loc").textContent = lat.toFixed(2) + ", " + lon.toFixed(2); } }

/* Notification„Çπ„Ç§„ÉÉ„ÉÅ */
function handleNotifToggle(checkbox) {
    const targetDisplay = document.getElementById("target-area-display");
    const targetName = document.getElementById("target-area-name");

    if (checkbox.checked) {
        if (myLat === null) {
            document.getElementById('welcome-overlay').style.display = 'flex';
            checkbox.checked = false;
            targetDisplay.style.display = "none";
            return;
        }
        
        // 1. „Åæ„ÅöË°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„Çπ„Ç§„ÉÉ„ÉÅ„ÅÆONË°®Á§∫„Å®Target area„ÅÆË°®Á§∫Ôºâ
        const currentLocation = document.getElementById("loc").textContent;
        targetName.textContent = currentLocation;
        targetDisplay.style.display = "block";
        
        notifLat = myLat;
        notifLon = myLon;

        // 2. „Çè„Åö„Åã„Å´ÈÅÖ„Çâ„Åõ„Å¶ alert „ÇíÂá∫„Åô„Åì„Å®„Åß„ÄÅ„Çπ„Ç§„ÉÉ„ÉÅ„ÅÆÊèèÁîª„ÇíÂÑ™ÂÖà„Åï„Åõ„Çã
        setTimeout(() => {
            alert(`Notifications have been set.\nTarget area: ${currentLocation}`);
        }, 15);
        
    } else {
        targetDisplay.style.display = "none";
        setTimeout(() => {
            alert(`Notifications have been cancelled.`);
        }, 15);
    }
}

function runNotificationChecks() { if (!document.getElementById('notif-toggle').checked) return; const lat = notifLat || myLat, lon = notifLon || myLon; if (lat === null) return; if (currentTotalScore >= 35) { triggerPushNotification("Aurora Alert!", "Aurora viewing chances are high in your area!", "lastNotifyChanceDate"); } }
function triggerPushNotification(title, message, storageKey) { const today = new Date().toDateString(); if (localStorage.getItem(storageKey) === today) return; if (Notification.permission === "granted") { navigator.serviceWorker.ready.then(reg => { reg.showNotification(title, { body: message, icon: "icon.png" }); localStorage.setItem(storageKey, today); }); } }

/* ÂÆüË°å„É´„Éº„Éó */
setInterval(() => { if (myLat !== null) updateAll(); }, 900000);
setInterval(() => { if (myLat !== null) runNotificationChecks(); }, 60000);

</script>
</body>
</html>
