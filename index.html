<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aurora Forecast Pro v. t1.3.1</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b132b">
<link rel="apple-touch-icon" href="icon.png">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { font-family: system-ui, sans-serif; background:#0b132b; color:#eaeaea; padding:20px; margin:0; }
.container { max-width:600px; margin: 0 auto; }
.header-area { display: flex; flex-direction: column; margin-bottom: 10px; }
.produce-by { font-size: 0.7rem; color: #8b949e; margin-top: -5px; margin-bottom: 10px; align-self: flex-end; }
.version { font-size: 0.4em; vertical-align: middle; color: #5bc0be; margin-left: 8px; font-weight: normal; }
.title-row { display: flex; justify-content: space-between; align-items: baseline; width: 100%; }
.beta-suffix { font-size: 0.6em; color: #8b949e; font-weight: normal; margin-left: 5px; text-transform: lowercase; }
h1 { margin: 0; font-size: 1.5rem; }
.card { background:#1c2541; padding:20px; border-radius:12px; margin-bottom:20px; position: relative; border: 1px solid #30363d; }
.label-main { font-size: 1.1rem; font-weight: bold; color: #5bc0be; margin-bottom: 0px; }
.label-sub-current { font-size: 0.8rem; color: #8b949e; margin-bottom: 10px; }
.value { font-size:1.6em; margin-top:4px; min-height: 1.2em; }
.sub-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #30363d; position: relative; }

.badge {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
    position: relative;
    /* --- è¿½åŠ ãƒ»ä¿®æ­£ --- */
    border: none;       /* ãƒœã‚¿ãƒ³ã®æ ç·šã‚’æ¶ˆã™ */
    cursor: pointer;    /* ãƒã‚¦ã‚¹ã‚’ä¹—ã›ãŸæ™‚ã«æŒ‡ãƒãƒ¼ã‚¯ã«ã™ã‚‹ */
    color: white;       /* æ–‡å­—è‰²ã‚’ç™½ã«å›ºå®š */
    transition: transform 0.1s, filter 0.2s; /* æŠ¼ã—å¿ƒåœ°ã®ãŸã‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
}

/* è¿½åŠ ï¼šãƒã‚¦ã‚¹ã‚’ç½®ã„ãŸæ™‚ã«å°‘ã—æ˜ã‚‹ã/
.badge:hover {
    filter: brightness(1.2); /* æ˜ã‚‹ã•ã‚’20%ã‚¢ãƒƒãƒ— */
    /* transform: translateY(-2px); 2pxã ã‘ä¸Šã«æµ®ã‹ã™(ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆä¸­) */
}

/* ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç¬é–“ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ */
.badge:active {
    transform: scale(0.95); /* å°‘ã—å‡¹ã‚€æ¼”å‡º */
    filter: brightness(0.9); /* å°‘ã—æš—ãã™ã‚‹æ¼”å‡º */
}

.badge-large { font-size: 1.5rem; }
.low { background:#475569; } .mid { background:#ca8a04; } .high { background:#dc2626; }
.cloud-icon { font-size: 0.8em; margin-left: 8px; vertical-align: middle; }
input, button { margin-top:6px; padding:6px 12px; border-radius: 4px; border: none; font-weight: bold; }

/* 1. é€šå¸¸ã®ãƒœã‚¿ãƒ³ (GPSãƒœã‚¿ãƒ³ãªã©) */
button { 
    cursor: pointer; 
    background: #3a506b; 
    color: white; 
    transition: 0.2s; 
    font-size: 0.9rem; 
}
/* 2. ãƒãƒƒã‚¸å‹ãƒœã‚¿ãƒ³ (Overall Probability, Aurora Oval) */
/* --- ä¿®æ­£å¾Œï¼šãƒœã‚¿ãƒ³ã¨ãƒãƒƒã‚¸ã®å…±é€šæ¼”å‡º --- */

/* 1. é€šå¸¸ãƒœã‚¿ãƒ³ã¨ãƒãƒƒã‚¸ã®åŸºæœ¬é·ç§»è¨­å®š */
button, .badge {
    transition: 0.2s; /* å¤‰åŒ–ã‚’æ»‘ã‚‰ã‹ã«ã™ã‚‹ */
}

/* 2. ãƒ›ãƒãƒ¼æ™‚ï¼ˆãƒã‚¦ã‚¹ã‚’ç½®ã„ãŸæ™‚ï¼‰ï¼šæ˜ã‚‹ã•ã‚’å¤‰ãˆã‚‹æ¼”å‡ºã«çµ±ä¸€ */
button:hover:not(:disabled),
.badge:hover {
    filter: brightness(1.3) !important; /* å€‹åˆ¥ã®è‰²æŒ‡å®šã«è² ã‘ãªã„ã‚ˆã†å„ªå…ˆåº¦ã‚’ä¸Šã’ã‚‹ */
    cursor: pointer;
}

/* 3. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ™‚ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ãŸç¬é–“ï¼‰ï¼šã‚ãšã‹ã«å‡¹ã¾ã›ã‚‹ */
button:active:not(:disabled),
.badge:active {
    transform: scale(0.97); /* æµ®ãä¸ŠãŒã‚‰ã›ãšã€å°‘ã—æ²ˆã‚€ã ã‘ã«ã™ã‚‹ */
    filter: brightness(0.9) !important;
}

/* --- ä»¥ä¸‹ã¯æ—¢å­˜ã®å€‹åˆ¥è¨­å®šã‚’ç¶­æŒ --- */
.badge {
    display: inline-block;
    padding: 10px 24px;
    border-radius: 30px;
    font-weight: bold;
    font-size: 1.2rem;
    letter-spacing: 0.05em;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    margin-top: 5px;
    position: relative;
    border: none;
    color: white;
}

button:disabled { opacity: 0.3; cursor: not-allowed; }
#btn-gps { width: auto; min-width: 220px; padding: 10px 20px; margin-bottom: 15px; }
.search-container { position: relative; display: inline-block; width: 100%; margin-top: 5px; }
#cityInput { width: calc(100% - 100px); box-sizing: border-box; }
.autocomplete-items { position: absolute; border: 1px solid #3a506b; border-bottom: none; border-top: none; z-index: 99; top: 100%; left: 0; right: 100px; background-color: #1c2541; border-radius: 0 0 4px 4px; max-height: 200px; overflow-y: auto; }
.autocomplete-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #30363d; font-size: 0.85rem; }
.autocomplete-item:hover { background-color: #3a506b; color: #5bc0be; }
.refresh-btn { position: absolute; top: 15px; right: 15px; font-size: 0.8em; padding: 4px 8px; }
.sub-refresh-btn { position: absolute; top: 15px; right: 0; font-size: 0.8em; padding: 4px 8px; }
.last-updated { font-size: 0.65rem; color: #8b949e; text-align: right; margin-top: 4px; font-family: monospace; min-height: 1em; }
.error-msg { color: #ff6b6b; font-size: 0.75rem; margin-top: 5px; min-height: 1em; opacity: 0; transition: 0.3s; }
.loading-text { opacity: 0.6; font-size: 1rem; color: #8b949e; font-style: normal; }
.loading-text i { font-style: italic; }
.loading-btn { pointer-events: none; filter: grayscale(0.5); opacity: 0.7; }
#hidden-data { display: none; }
.toggle-btn { width: 100%; margin-bottom: 20px; background: #1c2541; border: 1px solid #3a506b; color: #5bc0be; }
pre { background:#0b132b; padding:12px; border-radius:8px; font-family: monospace; font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; border: 1px solid #3a506b; min-height: 50px; }
#welcome-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 30000; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
.welcome-box { background: #5bc0be; color: #0b132b; padding: 25px; border-radius: 15px; text-align: center; font-weight: bold; font-size: 1.1rem; z-index: 30001; }
.arrow-container { display: flex; gap: 15px; margin-bottom: 10px; }
.thin-arrow { font-size: 2.5rem; color: #5bc0be; font-weight: 100; animation: bounceThin 1.2s infinite; }
@keyframes bounceThin { 0%, 100% { transform: translateY(0); opacity: 0.5; } 50% { transform: translateY(-15px); opacity: 1; } }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 20000; justify-content: center; align-items: center; cursor: pointer; }

.modal-content { background: #1c2541;
	width: 90%; 
	max-width: 450px; 
	padding:25px;
	border-radius: 12px; position:
	relative; border: 1px solid #5bc0be; 
	line-height: 1.6;
	cursor: pointer; /* default ã‹ã‚‰ pointer ã«å¤‰æ›´ */;
	max-height: 90vh; overflow-y: auto; }

.close-modal { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #8b949e; }
.score-big { font-size: 2.5rem; text-align: center; color: #fff; margin: 10px 0; font-weight: bold; }
.detail-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; margin-top: 10px; margin-bottom: 15px; }
.detail-table th, .detail-table td { text-align: left; padding: 8px; border-bottom: 1px solid #30363d; }
#map-screen { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 9999; background: #000; }
#map { width: 100%; height: 100%; background: #000; }
#back-btn { position: absolute; top: 90px; left: 10px; z-index: 10000; background: #21262d; border: 1px solid #30363d; color: white; padding: 8px 16px; }
.notification-card { border: 1px dashed #5bc0be !important; margin-top: 10px; }
.btn-test { background: #ca8a04 !important; }
.switch-container { display: flex; align-items: center; justify-content: flex-end; margin-top: 12px; gap: 10px; }
.switch-label { font-size: 0.75rem; color: #8b949e; }
.switch { position: relative; display: inline-block; width: 40px; height: 20px; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a506b; transition: .4s; border-radius: 20px; }
.slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
input:checked + .slider { background-color: #5bc0be; }
input:checked + .slider:before { transform: translateX(20px); }
</style>
</head>
<body onkeydown="closeWelcome()" onclick="closeWelcome(); closeAllLists();">

<div id="welcome-overlay">
    <div class="arrow-container">
        <div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div><div class="thin-arrow">â†‘</div>
    </div>
    <div class="welcome-box">Please enter a location first</div>
</div>

<div id="home-screen" class="container">
    <div class="header-area">
        <div class="title-row">
            <h1>ğŸŒŒ Aurora Forecast Pro<span class="beta-suffix">(beta)</span> <span class="version">v. t1.3.1</span></h1>
        </div>
        <div class="produce-by">Produce by Shin</div>
    </div>

    <div class="card notification-card">
        <div class="label-main" style="font-size: 0.9rem;">App Settings</div>
        <button id="btn-notif-test" class="btn-test" onclick="testNotification(); event.stopPropagation();">Send Test Notification</button>
        <div id="notif-status" style="font-size: 0.7rem; color: #8b949e; margin-top: 5px;">Push notifications: Triggered on "Possible" or "High"</div>
    </div>

    <div class="card" id="card-loc">
        <div class="label-main">Location</div>
        <div id="loc" class="value">Not Set</div>
        <button id="btn-gps" onclick="getLocation(); event.stopPropagation();">Get Current Location via GPS</button><br>
        Search City:
        <div class="search-container">
            <input id="cityInput" placeholder="e.g. Yellowknife, Canada" 
       oninput="handleCityInput(this)" 
       onclick="event.stopPropagation()">
            <button id="btn-search" onclick="searchCity(); event.stopPropagation();" disabled>Set</button>
            <div id="autocomplete-list" class="autocomplete-items"></div>
        </div>
        <div id="search-error" class="error-msg">City not found. Please check your input.</div>
    </div>

    <div class="card" id="card-main-result">
    <div id="total-label" class="label-main">Overall Probability</div>
    <div id="total-sub-label" class="label-sub-current">Status:</div>
    <button id="result" class="badge badge-large low" onclick="openModal(); event.stopPropagation();" style="border: none; width: auto; display: inline-block;">--</button>
    
    <div class="switch-container" style="position: absolute; top: 15px; right: 22px; margin-top: 0; display: flex; flex-direction: column; align-items: flex-end;">
    	<div style="display: flex; align-items: center; gap: 10px;">
        	<span class="switch-label">Notification</span>
        	<label class="switch">
            	<input type="checkbox" id="notif-toggle" onchange="handleNotifToggle(this); event.stopPropagation();">
            	<span class="slider"></span>
        	</label>
    	</div>
    	<div id="target-area-display" style="font-size: 0.65rem; color: #5bc0be; margin-top: 5px; text-align: right; line-height: 1.2; display: none;">
        	Target area:<br>
        	<span id="target-area-name" style="color: #eaeaea;"></span>
    	</div>
	</div>

    <div style="margin-top: 15px; display: flex; justify-content: flex-end;">
    	<button id="btn-update-all" 
            	style="width: auto; min-width: 100px; white-space: nowrap; font-size: 0.85em; background: #3a506b; padding: 8px 12px;" 
            	onclick="updateAll(); event.stopPropagation();">
        	Update Data
    	</button>
	</div>
    
    <div id="time-update-all" class="last-updated" style="margin-top: 10px;"></div>
</div>

    <button id="toggle-data-btn" class="toggle-btn" onclick="toggleData(); event.stopPropagation();">Show All Information</button>

    <div id="hidden-data">
        <div class="card" id="card-oval">
            <div class="label-main">Aurora Oval</div>
            <div class="label-sub-current">Current: (Click to View Map)</div>
            <div id="oval" class="badge low" onclick="showMapScreen(); event.stopPropagation();">--</div>
            <div id="oval-prob" style="font-size: 0.9rem; color: #8b949e; margin: 10px 0;"></div>
        </div>

        <div class="card" id="card-kp-group">
            <div class="label-main">Kp Index</div>
            <div class="label-sub-current">Current:</div>
            <div id="kp" class="badge low">--</div>
            <div class="sub-section" id="card-kp3">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="kp-short" class="value" style="font-size: 0.85rem; color: #5bc0be;">Ref 3-day forecast (NOAA)</div>
                <pre id="kpForecast" style="margin-top:10px;">--</pre>
            </div>
        </div>

        <div class="card" id="card-cloud-group">
            <div class="label-main">Cloud Cover</div>
            <div class="label-sub-current">Current:</div>
            <div id="cloud" class="badge low">--</div>
            <div class="sub-section" id="card-short">
                <div style="font-size: 0.8rem; color: #8b949e; margin-bottom: 5px;">Short Forecast:</div>
                <div id="forecast" class="value" style="font-size: 1rem;">--</div>
            </div>
        </div>
    </div>
</div>

<div id="detailModal" class="modal-overlay" onclick="closeModal()">
    <div class="modal-content">
        <div class="modal-title">Probability Details</div>
        <div class="score-big"><span id="score-pct">--</span></div>
        <div style="font-size: 0.85rem; margin-bottom: 15px;">
            <div style="border: 1px solid #3a506b; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #0b132b;">
                <strong style="color: #5bc0be;">Thresholds:</strong>
                <ul style="margin: 5px 0; padding-left: 20px;">
                    <li><span style="color: #dc2626;">High</span>: 70% or more</li>
                    <li><span style="color: #ca8a04;">Possible</span>: 35% to 69%</li>
                    <li><span style="color: #8b949e;">Low</span>: Under 35%</li>
                </ul>
            </div>
            <strong>Optimized Logic (v t1.0.13+):</strong>
            <table class="detail-table">
                <tr><th>Item</th><th>Max</th><th>Details</th></tr>
                <tr><td>Oval/Horizon</td><td>45</td><td>Base prob + Viewline bonus</td></tr>
                <tr><td>Magnetic</td><td>40</td><td>Kp Index sensitivity adjusted</td></tr>
                <tr><td>Sky</td><td>15</td><td>Clear sky impact</td></tr>
            </table>
            <p style="margin-top:10px; color: #ffab70; font-size: 0.8rem;">
                * <strong>Cloud Impact:</strong> If cloud cover exceeds 70%, the score is significantly reduced. If it exceeds 85%, the result is forced to "Low".<br><br>
                * <strong>Cloud Icon (â˜ï¸):</strong> This icon appears <strong>only when</strong> the aurora potential is "Possible" or "High" but the view is currently blocked by heavy cloud cover.
            </p>
        </div>
    </div>
</div>

<div id="map-screen">
    <button class="btn" id="back-btn" onclick="hideMapScreen();">â† Back</button>
    <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const CORS = "https://corsproxy.io/?";
const KP_URL = "https://services.swpc.noaa.gov/products/noaa-planetary-k-index.json";
const OVAL_URL = "https://services.swpc.noaa.gov/json/ovation_aurora_latest.json";
const FORECAST_URL = "https://services.swpc.noaa.gov/text/3-day-forecast.txt";

let myLat = null; let myLon = null; 
let notifLat = null; let notifLon = null;
let lastAuroraProb = 0; let cachedAuroraData = null;
let map = null; let auroraLayer = null; let userMarker = null; let cloudDataHourly = null;
let currentTotalScore = 0;
let lastScrollPos = 0;
let searchTimer = null;

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').then(() => console.log("SW Registered"));
}

/* --- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ»é€šçŸ¥é–¢é€£ --- */
function updateTimestamp(id) {
    const now = new Date();
    const pad = (num) => String(num).padStart(2, '0');
    const formatted = `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
    const el = document.getElementById(id);
    if (el) {
        el.textContent = `Last Update: ${formatted}`;
    }
}

function updateAllTimestamps() {
    ['time-update-all', 'time-kp', 'time-kp3', 'time-oval', 'time-cloud', 'time-short'].forEach(id => {
        updateTimestamp(id);
    });
}

// é€šçŸ¥ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã®é–¢æ•°
async function testNotification() {
    // 1. ã¾ãšæ¨©é™ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã™ã‚‹
    const permission = await Notification.requestPermission();
    
    if (permission === 'granted') {
        // 2. è¨±å¯ã•ã‚ŒãŸã‚‰é€šçŸ¥ã‚’å‡ºã™
        navigator.serviceWorker.ready.then(registration => {
            registration.showNotification("é€šçŸ¥ãƒ†ã‚¹ãƒˆ", {
                body: "é€šçŸ¥ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸï¼",
                icon: "/icon.png" // ã‚¢ã‚¤ã‚³ãƒ³ã®ãƒ‘ã‚¹ã‚’ç¢ºèª
            });
        });
    } else {
        alert("é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: " + permission);
    }
}

/* --- ãƒ‡ãƒ¼ã‚¿æ›´æ–°ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ --- */
async function updateAll() {
    // ä¿®æ­£ï¼šãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœªè¨­å®šæ™‚ã®å‡¦ç†ã‚’è¿½åŠ 
    if (myLat === null) {
        // ã‚¦ã‚§ãƒ«ã‚«ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’å†è¡¨ç¤ºã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ã™ã‚‹
        document.getElementById('welcome-overlay').style.display = 'flex';
        // ã‚ã‚‹ã„ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’å‡ºã™å ´åˆ: alert("Please set a location first");
        return;
    }
    
    const btn = document.getElementById('btn-update-all'); 
    if(btn) btn.classList.add('loading-btn');

    // ãƒãƒƒã‚¸éƒ¨åˆ†ã®ã¿ã‚’Loadingè¡¨ç¤ºã«ã™ã‚‹
    ['result','kp','oval','cloud'].forEach(id => setItemLoading(id, true));

    try {
        await Promise.all([
            getKp(), 
            fetchKp3DayForecast(), 
            checkOval(), 
            getCloud(), 
            shortForecast()
        ]);

        calculateTotal();
        runNotificationChecks();
        
        // æœ€å¾Œã«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ›¸ãæ›ãˆã‚‹
        updateAllTimestamps();
        
    } catch (e) {
        console.error("Update Data failed:", e);
    } finally {
        if(btn) btn.classList.remove('loading-btn');
    }
}

function calculateTotal() {
    const now = new Date();
    const hr = now.getHours();
    
    const subLabel = document.getElementById("total-sub-label");
    const isNight = (hr >= 21 || hr < 3);
    if (subLabel) {
        subLabel.textContent = isNight ? "Current Situation:" : "Tonight's Forecast (21:00):";
    }

    let evalKp = parseFloat(document.getElementById("kp").dataset.value) || 0;
    let evalCloud = (!isNight && cloudDataHourly) ? cloudDataHourly[21] : (parseInt(document.getElementById("cloud").dataset.value) || 0);

    let ovalScore = Math.min(45, (lastAuroraProb * 1.2) + (lastAuroraProb === 0 ? 5 : 10));
    let kpScore = Math.min(40, evalKp * 12 + (evalKp >= 3 ? 5 : 0));
    let potentialScore = (ovalScore + kpScore + 15) * (lastAuroraProb > 0 ? 1.0 : (evalKp >= 4 ? 0.3 : 0));

    if (evalCloud > 85) currentTotalScore = potentialScore * 0.1;
    else if (evalCloud > 70) currentTotalScore = potentialScore * 0.4;
    else currentTotalScore = potentialScore;

    const resultEl = document.getElementById("result");
    
    // è¡¨ç¤ºã¨åˆ¤å®šã‚’ä¸€è‡´ã•ã›ã‚‹ãŸã‚ã«å››æ¨äº”å…¥
    const displayScore = Math.round(currentTotalScore);

    if (displayScore >= 70) {
        resultEl.textContent = "High";
        resultEl.className = "badge badge-large high";
    } else if (displayScore >= 35) {
        resultEl.textContent = "Possible";
        resultEl.className = "badge badge-large mid";
    } else {
        resultEl.innerHTML = `Low${(potentialScore >= 35 && evalCloud > 70 ? '<span class="cloud-icon">â˜ï¸</span>' : '')}`;
        resultEl.className = "badge badge-large low";
    }
}

/* --- åœ°å›³ãƒ»ä½ç½®æƒ…å ±ãƒ»ãã®ä»– (ä»¥ä¸‹ã¯å¤‰æ›´ãªã—) --- */
async function getLocation() { setItemLoading('loc', true); navigator.geolocation.getCurrentPosition(async p => { myLat = p.coords.latitude; myLon = p.coords.longitude; await reverseGeocode(myLat, myLon); updateAll(); }, err => { alert("GPS Fetch Failed"); document.getElementById('loc').textContent = "Not Set"; }); }

function initMap() {
    const southLimit = -70, northLimit = 90;
    map = L.map('map', { 
        minZoom: 2, maxZoom: 10, worldCopyJump: true, 
        maxBounds: [[southLimit, -540], [northLimit, 540]], 
        maxBoundsViscosity: 1.0 
    });

    // --- è¿½åŠ ç®‡æ‰€ï¼šãƒãƒ¼ã‚«ãƒ¼ã‚’æœ€å‰é¢ã«æŒã£ã¦ãã‚‹ãŸã‚ã®è¨­å®š ---
    map.createPane('userMarkerPane');
    map.getPane('userMarkerPane').style.zIndex = 650; // ã‚ªãƒ¼ãƒ­ãƒ©ãƒ¬ã‚¤ãƒ¤ãƒ¼(400ç•ªå°)ã‚ˆã‚Šé«˜ã„æ•°å€¤
    map.getPane('userMarkerPane').style.pointerEvents = 'none'; // åœ°å›³æ“ä½œã®é‚ªé­”ã‚’ã—ãªã„
    // ------------------------------------------------

    const startLat = myLat !== null ? myLat : 70, startLon = myLon !== null ? myLon : 0;
    map.setView([startLat, startLon], 3);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { noWrap: false }).addTo(map);
    
    auroraLayer = L.layerGroup().addTo(map); 
    if (cachedAuroraData) drawAurora(cachedAuroraData); 
    updateMapMarker(); 
}

function drawAurora(data) { auroraLayer.clearLayers(); data.coordinates.forEach(p => { if (p[2] > 10) { let baseLon = p[0] > 180 ? p[0] - 360 : p[0]; let color = p[2] > 50 ? '#ff4500' : (p[2] > 25 ? '#ffff00' : '#00ff00'); [-360, 0, 360].forEach(offset => { L.rectangle([[p[1], baseLon + offset], [p[1] + 2, baseLon + 2 + offset]], { color: color, weight: 0, fillOpacity: p[2] / 100, interactive: false }).addTo(auroraLayer); }); } }); }

function showMapScreen() { 
    // è¿½åŠ ï¼šä½ç½®æƒ…å ±ãŒãªã„å ´åˆã¯ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢ã‚’å‡ºã—ã¦ä¸­æ–­
    if (myLat === null) { document.getElementById('welcome-overlay').style.display = 'flex'; return; }

    lastScrollPos = window.pageYOffset; 
    document.getElementById('home-screen').style.display = 'none'; 
    document.getElementById('map-screen').style.display = 'block'; 
    if (!map) initMap(); 
    else { 
        if (myLat !== null) map.setView([myLat, myLon], map.getZoom()); 
        updateMapMarker(); 
        setTimeout(() => { map.invalidateSize(); }, 50); 
    } 
}

function hideMapScreen() { document.getElementById('map-screen').style.display = 'none'; document.getElementById('home-screen').style.display = 'block'; window.scrollTo(0, lastScrollPos); }

function updateMapMarker() {
    if (!map || myLat === null) return;
    
    const pos = [myLat, myLon];
    if (userMarker) return userMarker.setLatLng(pos);

    userMarker = L.circleMarker(pos, { 
        fillColor: '#00ffff', // é®®ã‚„ã‹ãªã‚·ã‚¢ãƒ³
        radius: 8, 
        stroke: false,        // weight: 0 --> æ ç·šã‚’å®Œå…¨ã«ã‚ªãƒ•
        fillOpacity: 1, // ä¸é€æ˜åº¦1.0ã§ã‚ªãƒ¼ãƒ­ãƒ©ãŒé€ã‘ãªã„ã‚ˆã†ã«ã™ã‚‹
        pane: 'userMarkerPane' // æœ€å‰é¢ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’æŒ‡å®š
    }).addTo(map);
}

async function getKp() { try { const res = await fetch(CORS + encodeURIComponent(KP_URL)); const data = await res.json(); const val = parseFloat(data[data.length - 1][1]); const el = document.getElementById("kp"); el.textContent = val.toFixed(1); el.dataset.value = val; el.className = "badge " + (val >= 5 ? "high" : (val >= 3 ? "mid" : "low")); return val; } catch(e) { return 0; } }
async function fetchKp3DayForecast() { try { const res = await fetch(CORS + encodeURIComponent(FORECAST_URL)); const text = await res.text(); const match = text.match(/NOAA Kp index breakdown[\s\S]*?(?=\n[A-Z]|$)/i); document.getElementById("kpForecast").innerText = match ? match[0].trim() : "Updating..."; } catch(e) { } }
async function checkOval() { try { const res = await fetch(CORS + encodeURIComponent(OVAL_URL)); const data = await res.json(); cachedAuroraData = data; if (map) drawAurora(data); let bestProb = 0, minDiff = 999; data.coordinates.forEach(p => { let diff = Math.abs(myLat - p[1]) + Math.abs(myLon - (p[0] > 180 ? p[0] - 360 : p[0])); if (diff < minDiff) { minDiff = diff; bestProb = p[2]; } }); lastAuroraProb = bestProb; document.getElementById("oval-prob").textContent = `Probability at location: ${bestProb}%`; document.getElementById("oval").className = "badge " + (bestProb >= 10 ? "high" : "low"); document.getElementById("oval").textContent = (bestProb >= 10 ? "Near Oval" : "Outside Oval"); } catch(e) { } }
async function getCloud() { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&current=cloudcover`); const data = await res.json(); const val = data.current.cloudcover; const el = document.getElementById("cloud"); el.textContent = formatProbability(val); el.dataset.value = val; el.className = "badge " + (val <= 20 ? "high" : (val <= 60 ? "mid" : "low")); return val; } catch(e) { return 100; } }
async function shortForecast() { try { const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${myLat}&longitude=${myLon}&hourly=cloudcover`); const data = await res.json(); cloudDataHourly = data.hourly.cloudcover; const hr = new Date().getHours(); let html = (hr >= 21 || hr < 3) ? `<div>ğŸ•’ In 3h: Clouds ${formatProbability(cloudDataHourly[3])}</div>` : `<div>ğŸŒ™ Tonight(21:00): Clouds ${formatProbability(cloudDataHourly[21])}</div>`; html += `<div>ğŸ“… Tomorrow(21:00): Clouds ${formatProbability(cloudDataHourly[45])}</div>`; document.getElementById("forecast").innerHTML = html; } catch(e) { } }
function setItemLoading(id, isLoading) { const el = document.getElementById(id); if (el && isLoading) el.innerHTML = '<span class="loading-text">âŒ› <i>Loading...</i></span>'; }
function formatProbability(s) { const r = Math.round(s); return (r <= 0 ? "< 1" : (r >= 100 ? "> 99" : r)) + " %"; }


async function searchCity() {
    const cityInput = document.getElementById("cityInput");
    const city = cityInput.value.trim();
    if (!city) return;

    // 1. å‹•ã„ã¦ã„ã‚‹æ¤œç´¢ã‚¿ã‚¤ãƒãƒ¼ã‚’å³åº§ã«æ­¢ã‚ã‚‹
    clearTimeout(searchTimer);

    try {
        const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=en`);
        const data = await res.json();
        if (data.results?.length > 0) {
            const r = data.results[0];
            myLat = r.latitude;
            myLon = r.longitude;
            document.getElementById("loc").textContent = `${r.name}, ${r.country}`;
            
            // 2. å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            cityInput.value = "";
            document.getElementById("btn-search").disabled = true;
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
            cityInput.blur();
            
            // ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã‚ºãƒ¼ãƒ ã‚’å¼·åˆ¶è§£é™¤
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                const originalContent = viewport.content;
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
                setTimeout(() => {
                    viewport.content = originalContent; // å…ƒã®è¨­å®šã«æˆ»ã™
                }, 300);
            }
            
            // ç”»é¢ã®ã‚ºãƒ¼ãƒ /ä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
            //window.scrollTo({ top: 0, behavior: 'smooth' }); // é¢æœ€ä¸Šéƒ¨ã¸ã‚¹ãƒ ãƒ¼ã‚ºã«æˆ»ã‚‹

            // 3. ãƒªã‚¹ãƒˆã‚’ç‰©ç†çš„ã«ç ´å£Šã—ã¦ç¢ºå®Ÿã«æ¶ˆã™
            const list = document.getElementById("autocomplete-list");
            if (list) list.innerHTML = ""; 
            
            updateAll();
        } else {
            const err = document.getElementById("search-error");
            err.style.opacity = 1;
            setTimeout(() => { err.style.opacity = 0; }, 3000);
        }
    } catch (e) {
        console.error("Search Error");
    }
}


function handleCityInput(el) {
    const val = el.value.trim();
    const btn = document.getElementById("btn-search");
    
    // æ–‡å­—ãŒã‚ã‚Œã°Setãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
    btn.disabled = val.length === 0;

    clearTimeout(searchTimer);
    if (val.length < 2) {
        closeAllLists();
        return;
    }

    searchTimer = setTimeout(async () => {
        try {
            const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(val)}&count=5&language=en`);
            const data = await res.json();
            // å€™è£œã‚’è¡¨ç¤º
            showAutocomplete(data.results);
        } catch(e){
            console.error("Autocomplete fetch error", e);
        }
    }, 300);
}


function showAutocomplete(results) {
    const list = document.getElementById("autocomplete-list");
    list.innerHTML = ""; // ä¸€æ—¦ä¸­èº«ã‚’ç©ºã«ã™ã‚‹
    
    if (!results || results.length === 0) return;

    results.forEach(res => {
        const item = document.createElement("div");
        item.className = "autocomplete-item";
        item.innerHTML = `<strong>${res.name}</strong>, ${res.country}`;
        
        // clickã§ã¯ãªãmousedownã‚’ä½¿ã†ã®ãŒã‚³ãƒ„ã§ã™
        item.onmousedown = (e) => {
            e.preventDefault(); 
            
            // 1. ä½ç½®æƒ…å ±ã‚’ç¢ºå®š
            myLat = res.latitude;
            myLon = res.longitude;
            document.getElementById("loc").textContent = `${res.name}, ${res.country}`;
            
            // 2. æ¤œç´¢çª“ã‚’ã‚¯ãƒªã‚¢
            const inputField = document.getElementById("cityInput");
            inputField.value = "";
            document.getElementById("btn-search").disabled = true;
            
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’å¤–ã—ã¦ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚’é–‰ã˜ã‚‹
            inputField.blur();
            
            // --- ã‚ºãƒ¼ãƒ è§£é™¤ ---
            inputField.blur(); 
            const viewport = document.querySelector('meta[name="viewport"]');
            if (viewport) {
                const originalContent = viewport.content;
                viewport.content = 'width=device-width, initial-scale=1, maximum-scale=1';
                setTimeout(() => {
                    viewport.content = originalContent;
                }, 300);
            }
            
            // ç”»é¢æœ€ä¸Šéƒ¨ã¸ã‚¹ãƒ ãƒ¼ã‚ºã«æˆ»ã‚‹
            window.scrollTo({ top: 0, behavior: 'smooth' }); 

            // 3. ãƒªã‚¹ãƒˆã‚’é–‰ã˜ã¦æ›´æ–°
            closeAllLists();
            updateAll();
        };
        list.appendChild(item);
    });
}

function closeAllLists() {
    clearTimeout(searchTimer); // ã“ã“ã§ã‚‚ã‚¿ã‚¤ãƒãƒ¼ã‚’æ­¢ã‚ã‚‹
    const list = document.getElementById("autocomplete-list");
    if (list) {
        list.innerHTML = "";
    }
}


function closeWelcome() { document.getElementById('welcome-overlay').style.display = 'none'; }
function toggleData() { const h = document.getElementById("hidden-data"), b = document.getElementById("toggle-data-btn"); const isH = h.style.display !== "block"; h.style.display = isH ? "block" : "none"; b.textContent = isH ? "Show Less Information" : "Show All Information"; }

/* View Detailsãƒœã‚¿ãƒ³ */
function openModal() {
    // ä¿®æ­£ï¼šalertã§ã¯ãªãã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¡¨ç¤ºã™ã‚‹æŒ™å‹•ã«çµ±ä¸€
    if (myLat === null) {
        document.getElementById('welcome-overlay').style.display = 'flex';
        return;
    }
    
    document.getElementById("score-pct").textContent = formatProbability(currentTotalScore);
    document.getElementById("detailModal").style.display = "flex";
}




function closeModal() { document.getElementById("detailModal").style.display = "none"; }
async function reverseGeocode(lat, lon) { try { const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`); const data = await res.json(); document.getElementById("loc").textContent = (data.address.city || data.address.town || "Unknown") + ", " + data.address.country; } catch (e) { document.getElementById("loc").textContent = lat.toFixed(2) + ", " + lon.toFixed(2); } }

/* Notificationã‚¹ã‚¤ãƒƒãƒ */
function handleNotifToggle(checkbox) {
    const targetDisplay = document.getElementById("target-area-display");
    const targetName = document.getElementById("target-area-name");

    if (checkbox.checked) {
        if (myLat === null) {
            document.getElementById('welcome-overlay').style.display = 'flex';
            checkbox.checked = false;
            targetDisplay.style.display = "none";
            return;
        }
        
        // 1. ã¾ãšè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¹ã‚¤ãƒƒãƒã®ONè¡¨ç¤ºã¨Target areaã®è¡¨ç¤ºï¼‰
        const currentLocation = document.getElementById("loc").textContent;
        targetName.textContent = currentLocation;
        targetDisplay.style.display = "block";
        
        notifLat = myLat;
        notifLon = myLon;

        // 2. ã‚ãšã‹ã«é…ã‚‰ã›ã¦ alert ã‚’å‡ºã™ã“ã¨ã§ã€ã‚¹ã‚¤ãƒƒãƒã®æç”»ã‚’å„ªå…ˆã•ã›ã‚‹
        setTimeout(() => {
            alert(`Notifications have been set.\nTarget area: ${currentLocation}`);
        }, 15);
        
    } else {
        targetDisplay.style.display = "none";
        setTimeout(() => {
            alert(`Notifications have been cancelled.`);
        }, 15);
    }
}

function runNotificationChecks() { if (!document.getElementById('notif-toggle').checked) return; const lat = notifLat || myLat, lon = notifLon || myLon; if (lat === null) return; if (currentTotalScore >= 35) { triggerPushNotification("Aurora Alert!", "Aurora viewing chances are high in your area!", "lastNotifyChanceDate"); } }
function triggerPushNotification(title, message, storageKey) { const today = new Date().toDateString(); if (localStorage.getItem(storageKey) === today) return; if (Notification.permission === "granted") { navigator.serviceWorker.ready.then(reg => { reg.showNotification(title, { body: message, icon: "icon.png" }); localStorage.setItem(storageKey, today); }); } }

/* å®Ÿè¡Œãƒ«ãƒ¼ãƒ— */
setInterval(() => { if (myLat !== null) updateAll(); }, 900000);
setInterval(() => { if (myLat !== null) runNotificationChecks(); }, 60000);

</script>
</body>
</html>

