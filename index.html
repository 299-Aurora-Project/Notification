/* v t1.1.1 - 通知エラー修正版 */

async function testNotification() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === "granted") {
            const registration = await navigator.serviceWorker.ready;
            registration.showNotification("Aurora Forecast Test", {
                body: "Notification system is working correctly!",
                // icon: "icon.png" // 画像がない場合は一旦コメントアウト
            });
        } else {
            alert("Please enable notifications in your browser settings.");
        }
    } catch (e) {
        console.error("Notification Error:", e);
    }
}

function checkAndNotify(score, statusText) {
    let lastNotifyDate = null;
    try {
        lastNotifyDate = localStorage.getItem('lastNotifyDate');
    } catch (e) {
        console.warn("Storage access blocked. Notification limit might not work.");
    }
    
    const today = new Date().toDateString();

    if (score >= 35 && lastNotifyDate !== today) {
        if (Notification.permission === "granted") {
            navigator.serviceWorker.ready.then(registration => {
                registration.showNotification("Aurora Alert!", {
                    body: `Aurora possibility is ${statusText} (${Math.round(score)}%) at your location!`,
                    // icon: "icon.png" // 画像がない場合は一旦コメントアウト
                });
                try {
                    localStorage.setItem('lastNotifyDate', today);
                } catch (e) {}
            });
        }
    }
}
